<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Senior Finance AI Service</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: white;
      }
      .phone {
        width: 360px;
        height: 700px;
        background: #0b0b0b;
        border-radius: 40px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        position: relative;
      }
      #status {
        margin-bottom: 10px;
        text-align: center;
        font-size: 16px;
      }
      #recordBtn {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: none;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
      }
      #recordBtn.end {
        background-color: #e53935;
      }
      #dialpad {
        display: none;
        margin-top: 10px;
        width: 240px;
        height: 320px;
        background: #111;
        border-radius: 20px;
        padding: 10px;
        box-sizing: border-box;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 10px;
        justify-items: center;
        align-items: center;
      }
      .dial-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #333;
        color: white;
        font-size: 20px;
        font-weight: bold;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="phone">
      <h1>Senior Finance AI Service</h1>
      <p id="status">ğŸ“ í†µí™” ëŒ€ê¸° ì¤‘</p>
      <button id="recordBtn">ì „í™” ë°›ê¸°</button>

      <div id="dialpad">
        <button class="dial-btn" data-val="1">1</button>
        <button class="dial-btn" data-val="2">2</button>
        <button class="dial-btn" data-val="3">3</button>
        <button class="dial-btn" data-val="4">4</button>
        <button class="dial-btn" data-val="5">5</button>
        <button class="dial-btn" data-val="6">6</button>
        <button class="dial-btn" data-val="7">7</button>
        <button class="dial-btn" data-val="8">8</button>
        <button class="dial-btn" data-val="9">9</button>
        <button class="dial-btn" data-val="*">*</button>
        <button class="dial-btn" data-val="0">0</button>
        <button class="dial-btn" data-val="#">#</button>
      </div>
    </div>

    <script>
      let mediaRecorder,
        audioChunks = [],
        inCall = false;

      const btn = document.getElementById("recordBtn");
      const status = document.getElementById("status");
      const dialpad = document.getElementById("dialpad");
      const dialButtons = document.querySelectorAll(".dial-btn");

      // ------------------------------
      // ì•ˆì •ì ì¸ ë…¹ìŒ í•¨ìˆ˜
      // ------------------------------
      async function startRecording(durationMs = 5000) {
        try {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            console.warn("ì´ë¯¸ ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤.");
            return;
          }

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

          return new Promise((resolve, reject) => {
            mediaRecorder.onstop = () => {
              status.innerText = "âœ… ë…¹ìŒ ì™„ë£Œ";
              resolve();
            };

            mediaRecorder.start();
            status.innerText = "ğŸ™ï¸ ë…¹ìŒ ì¤‘...";

            setTimeout(() => {
              if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
              }
            }, durationMs);
          });
        } catch (err) {
          console.error(err);
          status.innerText = "ë§ˆì´í¬ ê¶Œí•œ í•„ìš”!";
        }
      }

      // ------------------------------
      // ì„œë²„ ì „ì†¡ í•¨ìˆ˜
      // ------------------------------
      async function sendToServer() {
        status.innerText = "â³ ì„œë²„ ì „ì†¡ ì¤‘...";
        const formData = new FormData();
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        formData.append("files", audioBlob, "voice.webm");

        try {
          const res = await fetch("/stt-gpt", {
            method: "POST",
            body: formData,
          });
          const html = await res.text();
          document.open();
          document.write(html);
          document.close();
        } catch (err) {
          console.error(err);
          status.innerText = "âš ï¸ ì „ì†¡ ì‹¤íŒ¨!";
        }
      }

      // ------------------------------
      // í†µí™” ì‹œì‘ TTS + ë…¹ìŒ
      // ------------------------------
      async function startCallFlow() {
        const ttsUtterance = new SpeechSynthesisUtterance(
          "ì•ˆë…•í•˜ì„¸ìš”. ê¸ˆìœµ ì¸ê³µì§€ëŠ¥ ìƒë‹´ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. 1ë²ˆì„ ëˆ„ë¥´ë©´ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤."
        );
        ttsUtterance.lang = "ko-KR";
        ttsUtterance.onend = async () => {
          await startRecording(5000);
        };
        speechSynthesis.speak(ttsUtterance);
      }

      // ------------------------------
      // ì „í™” ë°›ê¸° / ì¢…ë£Œ ë²„íŠ¼
      // ------------------------------
      btn.onclick = async () => {
        if (!inCall) {
          inCall = true;
          btn.classList.add("end");
          btn.innerText = "í†µí™” ì¢…ë£Œ";
          status.innerText = "âœ… í†µí™” ì¤‘...";
          dialpad.style.display = "grid";
          await startCallFlow();
        } else {
          inCall = false;
          btn.classList.remove("end");
          btn.innerText = "ì „í™” ë°›ê¸°";
          status.innerText = "ğŸ“ í†µí™” ëŒ€ê¸° ì¤‘";
          dialpad.style.display = "none";
          speechSynthesis.cancel();
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
        }
      };

      // ------------------------------
      // 1ë²ˆ ë²„íŠ¼ í´ë¦­ â†’ ë…¹ìŒ + ì„œë²„ ì „ì†¡
      // ------------------------------
      dialButtons.forEach((btn) => {
        btn.onclick = async () => {
          if (btn.dataset.val === "1") {
            if (mediaRecorder && mediaRecorder.state === "recording") {
              status.innerText = "â³ ë…¹ìŒ ì™„ë£Œ í›„ ì„œë²„ ì „ì†¡ ì¤‘...";
              mediaRecorder.onstop = async () => {
                status.innerText = "âœ… ë…¹ìŒ ì™„ë£Œ, ì„œë²„ ì „ì†¡ ì¤‘...";
                await sendToServer();
              };
              mediaRecorder.stop();
            } else {
              status.innerText = "â³ ë…¹ìŒ ì‹œì‘ í›„ ì„œë²„ ì „ì†¡ ì¤‘...";
              await startRecording(5000);
              await sendToServer();
            }
          }
        };
      });
    </script>
  </body>
</html>
